# Шаблон инфраструктурного репозитория
## Зачем он нужен
Почти всегда инфраструктурный код (Terraform + Ansible + [Packer, etc]), описывающий ***один*** сервис, должен храниться в ***одном отдельном*** репозитории и исполняться одним пайплайном. Такие репозитории удобно сопровождать, удобно разделять права, splash damage в случае чего-то непредвиденного минимален.  
При этом старт нового проекта, написание и отладка кода должны быть максимально простыми, как и перенос кода из одного окружения в другое.  
Этот шаблон позволяет мгновенно приступить к разработке нового сервиса, написать и отладить код с собственного ПК в проекте-песочнице, а затем перенести его в любое боевое окружение через CI/CD-пайплайн без изменений за пару секунд.
## Быстрый старт
- Нажми ***New project*** в соответствующей Gitlab-группе, выбери ***Import***, ***Repo by URL***, вставь адрес шаблона https://gitlab.example.com/infrastructureascode/lib/iac-gitlab-template.git и введи свои логин-пароль от Гитлаба.  
- Склонируй проект на свой ПК в Linux-среду (например, WSL) через **git clone**
- Прочитай ридми в каталоге **keys**, чтобы инициализировать доступы
- Используй приведённые примеры, чтобы на их основе писать и запускать локально Terraform-код и Ansible-код в соответствующих каталогах
- Используй те же переменные для ssh и winrm, что используются в примерах - они нужны для правильной работы пайплайнов
- Подключайся к созданным инстансам, используя обычный персональный ssh-ключ и winrm-сертификат
- Если какие-то значения (например, размеры флейворов или необходимость введения в домен) должны быть разными между окружениями:
    - В Terraform создавай переменные в **variables.tf**, значения добавляй в файлы окружений **environment/** и в **local.auto.tfvars** для локально исполняемого кода
    - В Ansible задавай значения переменных внутри каждого плея - это будут значения по-умолчанию для исполнения кода локально, а для других окружений задавай значения в **environment/**
- Когда будешь готов, запушь код в репозиторий на Гитлабе, раскомментировав в **.gitlab-ci.yml** нужные окружения и типы пайплайнов
## Инструменты
В стадии Tools есть несколько инструментов для удобной разработки
- Чтобы получить актуальный список флейворов и образов в облачном проекте, используй джобы **OS flavor** и **OS images** в разделе Tools
- Чтобы удалить все созданные Terraform-кодом объекты, используй джобу TF destroy (доступна только для Plaground)
- Если джоба TF apply была прервана до штатного завершения и блокировка со стейт-файла не была удалена автоматически, при следующем запуске TF джобы ты получишь ошибку. Чтобы удалить в таком случае лок со стейт-файла, используй TF remove lock.
## Быстрое получение пароля Windows
Для созданных на основе приведённых примеров Windows-инстансов в песочнице можно быстро и легко получить пароль администратора. Для этого просто запусти **keys/get_windows_password.sh** и введи имя интересующего инстанса. Скрипт автоматически приведёт твои ключи в нужный формат, запросит Openstack и расшифрует его твоим приватным ключом. Результат выглядит так:

    Please enter hostname you want to get password for: 
    v-app-example
    ========================
    Login: Admin
    Password: xxxxxxxxxxxxxx

# Как это работает
Для удобства локальной разработки шаблоны и примеры так написаны, чтобы исполняемый код использовал существующие на машине пользователя ssh и winrm ключи. Данные для доступа к облаку задаются через переменные окружения. Разные переменные для одного и того же кода в разных окружениях задаются в одноимённых файлах.  
Заботу об автоматической подстановке боевых ключей и применении для каждого боевого окружения соответствующих файлов переменных берёт на себя пайплайн.  
Сам пайплайн написан модульно и расположен в [отдельном репозитории](https://gitlab.example.com/infrastructureascode/lib/pipelines) для того, чтобы разработчику сервиса было удобнее подключать нужные джобы в нужных ему окружениях.  
Все локальные изменения, относящиеся к локальному запуску кода (загруженные Terraform-модули, Ansible-роли, локальный стейт и лок-файлы и пр.) исключены из обработки Гитом через .gitignore, чтобы оставить репозиторий сервиса чистым.  
# Особенности использования Ansible-пайплайна
## Линтер
Джоба **ANS Validate**, кроме проверки синтаксиса, также запускает и линтер **ansible-lint**. Линтер запускается с параметрами исключений, указанными в файле .ansible-lint - по-умолчанию из проверки исключены все роли и коллекции. Можно дополнить параметры исключений [своими правилами](https://ansible-lint.readthedocs.io/en/latest/configuring.html)
## Теги
Для ускорения выполнения плейбука, можно ограничить теги, таски с которыми будут запускаться. Для этого при запуске пайплайна можно задать в переменной **t** список тегов. Это равнозначно ручному запуску плейбука с опцией *-t=tag1,tag2,tag3*.
## Хосты
Для ускорения выполнения плейбука, можно ограничить список хостов или групп, против которых должен выполняться плейбук. Для этого задай в переменной **h** список хостов или групп. Это равнозначно ручному запуску плейбука с опцией *-l=host1,group2*.
## Ansible Vault
Если в Ansible-плейбуке нужно использовать несколько секретов, правильнее всего будет хранить их в зашифрованном файле ansible/vault-vars.yml, и подключать его через **include_vars**. Пайплайны автоматически расшифруют vault-файл, если задать пароль в CI/CD-переменной проекта **ANSIBLE_VAULT_PASS**.  
Для удобства в шаблоне есть скрипт для инициализации vault-файла **keys/create_vault.sh**
# Хорошие практики
- Используй следующую схему **metadata**-тегов в Terraform:

```
os = linux/windows
os_ver = ubuntu18/ubuntu20/2019/2016
app = (основное приложение сервера, напр. mongo или 1c, можно несколько тегов app подряд)
service = (сервис, который обслуживает этот сервер, напр. для тестовых серверов и SQL-сервер и App-сервер и Mongo-сервер должны иметь одно значение, напр. "qa-servers")
```

- Production-ready сервис должен быть покрыт мониторингом. Добавь в Zabbix дашборд со всеми важными метриками.
- Документируй создаваемый сервис. Удали из этого ридми всё, кроме шаблона в конце, и с его помощью опиши:
    - Зачем нужен сервис
    - По какой Jira-задаче создан
    - В каких окружениях должен работать сервис
    - Если часть конфигурации производится вручную, напиши, какая именно
    - Используемые теги Ansible
    - Автор проекта

# Список флейворов и образов
Посмотреть текущий список флейворов и образов в проекте можно, воспользовавших джобами **OS flavor** и **OS images** в пайплайне.  
Но для удобства ниже приведён примерный список флейворов и образов:
<details>
  <summary>Список флейворов</summary>

    +--------------------------------------+-------------------+--------+------+-----------+-------+-----------+
    | ID                                   | Name              |    RAM | Disk | Ephemeral | VCPUs | Is Public |
    +--------------------------------------+-------------------+--------+------+-----------+-------+-----------+
    | 09dc3eb9-fc46-44b1-8928-acd42f723747 | Standard-4-12     |  12288 |    0 |         0 |     4 | True      |
    | 12dc66d3-828c-4495-a5ca-ea1710c33174 | Advanced-12-24    |  24576 |    0 |         0 |    12 | True      |
    | 19b38715-48cd-495b-9391-4c4e9d424518 | Basic-1-2-40      |   2048 |   40 |         0 |     1 | True      |
    | 25ae869c-be29-4840-8e12-99e046d2dbd4 | Basic-1-2-20      |   2048 |   20 |         0 |     1 | True      |
    | 283fa444-8d59-4e83-b6f4-90613c52a5a4 | Advanced-8-16-100 |  16384 |  100 |         0 |     8 | True      |
    | 2c7c3f57-b5a4-4139-af7d-d5f05d70c703 | Standard-6-24     |  24576 |    0 |         0 |     6 | True      |
    | 4e115a9b-0ac2-440d-a120-95cf130d63c7 | Standard-2-2      |   2048 |    0 |         0 |     2 | True      |
    | 52f90145-a38e-438d-9c4b-3874b6355db3 | Advanced-8-8      |   8192 |    0 |         0 |     8 | True      |
    | 59f7faf3-d817-4cb8-ae69-8b4b92565f94 | Advanced-16-64-50 |  65536 |   50 |         0 |    16 | True      |
    | 5fb1ab8f-fdab-4b43-a785-ef87b06ed2dd | Standard-6-6      |   6144 |    0 |         0 |     6 | True      |
    | 670f9d36-d01b-4a4a-a8e5-c88cfb9ea0ec | Advanced-16-32-50 |  32768 |   50 |         0 |    16 | True      |
    | 684e04db-13d6-4879-aff7-14cb98e7577a | Advanced-8-24     |  24576 |    0 |         0 |     8 | True      |
    | 69cd369e-312a-4098-bdd9-112d092b7ad3 | Advanced-12-36    |  36864 |    0 |         0 |    12 | True      |
    | 6d89f25a-a4b5-4b4d-b2fa-d08d701e5106 | Advanced-12-12    |  12288 |    0 |         0 |    12 | True      |
    | 738b4989-2105-45aa-acf5-ed243d59a968 | Standard-6-12     |  12288 |    0 |         0 |     6 | True      |
    +--------------------------------------+-------------------+--------+------+-----------+-------+-----------+
</details>

<details>
  <summary>Список образов</summary>

    +--------------------------------------+------------------------------------------------------+--------+
    | ID                                   | Name                                                 | Status |
    +--------------------------------------+------------------------------------------------------+--------+
    | 44709803-5ec2-496b-88b7-85a5250e51c4 | CentOS-7.9-202107                                    | active |
    | c234f854-8555-4976-a2c6-3148ee0396cb | CentOS-8.0-201910                                    | active |
    | 1a30f1f7-c86c-4877-837d-f60939efbcdd | CentOS-8.1-202004                                    | active |
    | c9b7a469-a7ed-4119-b840-fd5169ee4348 | CentOS-8.4-202107                                    | active |
    | d9afee9f-6fa9-4e9a-81a2-cccf153a2eb2 | Centos-8-v1.21.4-mcs.3                               | active |
    | 024f4129-5fc9-43c5-8f64-946859e20e5c | Debian-10.1-202004                                   | active |
    | d95b5e0a-77da-4943-b773-4b10ecf8ad3a | Fedora-Atomic-28-v1.16.4-mcs.1                       | active |
    | 76976cf9-5b7c-40ce-ad59-4fea9bc05d90 | FreeBSD-10.3                                         | active |
    | 9857957b-cd4d-457c-9510-7f2408c7a7f8 | Ubuntu-16.04-Standard                                | active |
    | 64995697-2d04-42b0-b5d2-c78dcd4c4b84 | Ubuntu-18.04-Standard                                | active |
    | fcdee862-6053-4270-9812-728b47ad2833 | Ubuntu-19.10-202003                                  | active |
    | d853edd0-27b3-4385-a380-248ac8e40956 | Ubuntu-20.04.1-202008                                | active |
    | 5b76aa28-0a84-44c3-991b-47010d38d006 | Windows-Server-2016Std-en.202105                     | active |
    | 48165a2a-68f8-472d-92cd-f3193fc7252f | Windows-Server-2016Std-ru.202105                     | active |
    | 7e6ee571-c8e9-43c3-b642-f926772a6e71 | Windows-Server-2019Std-en.202105                     | active |
    | e06c15f3-5de2-4acd-aee9-d3eb50709243 | Windows-Server-2019Std-ru.202105                     | active |
    | 37ac2f45-fb81-4558-9f29-5024d26f9120 | Windows-Server-2022Std-en.202111                     | active |
    | c15caaf0-083c-41f1-9090-25a1b79b8438 | Windows-Server-2022Std-ru.202111                     | active |
    | b3464217-99f0-489a-8003-beeca875df07 | Windows-Server-2022StdCore-en.202111                 | active |
    | c17ff31f-3f40-4bf4-bbc1-955d91d3b054 | Windows-Server-2022StdCore-ru.202111                 | active |
    | c636eb5e-d719-44c7-b3ce-e4d888c97c5f | openSUSE-42.3-Standard                               | active |
    +--------------------------------------+------------------------------------------------------+--------+
</details>
  
# Шаблон для ридми (удали всё, что выше и замени строку на имя сервиса)
## Информация о сервисе
### Автор
ФИО
### Задача
https://jira.example.com/
### Окружения
PROD, DEVQA
### Описание сервиса
...
## Ручная конфигурация
Если сервис частично конфигурируется вручную, опиши здесь, как именно или приведи ссылку на документацию в Буксе
### Ansible-теги
- tag1 - один тип задач
- tag2 - второй тип задач
## Мониторинг
Ссылка на дашборд в Заббиксе: https://zabbix.example.com
